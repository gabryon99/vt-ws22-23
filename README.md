# Virtualization Techniques

This repository contains the tasks of the [second homework](./docs/homework.pdf) for the *Virtualization Techniques* course at TUM.

## Machine's Specification

### Registers

The Virtual Machine has 3 registers:
1. `IP` (Instruction Pointer): hold 32-bit positive address
2. `A` (Accumulator): hold 32-bit signed values
3. `L` (Loop Counter): hold 32-bit signed values 

At the beginning, the IP register has value 0. Registers A and L are customizable by the user (boot params).

### Instruction Set

The machine has 7 instructions, encoded as 1 byte (=opcode):
1. `HALT  (0x00)`: stops the machine;
2. `CLRA  (0x01)`: clear the register A (aka. set A = 0);
3. `INC3A (0x02)`: increment register A of 3 (aka. A += 3);
4. `DECA  (0x03)`: decrement register A of 1 (aka. A -= 1);
5. `SETL  (0x04)`: copy value of register A to register L (aka. L = A);
6. `BACK7 (0x05)`: decrement the value of register L. If the value of L is positive, jump back of 7 instructions (i.e. loop body is 6 one-byte instructions and the BACK7 itself). Otherwise, continue the execution
7. `UKN (0xff)`: invalid opcode.

## Tasks

### First Tasks

- [x] Define a data structure able to hold the machine state.
- [x] Write an interpreter for this ISA which is able to execute a program given as a byte array and a given machine state, returning at HALT.
- [ ] Measure the **average time** required by your interpreter for executing one instruction, averaged across the input scenarios (generated by the C code, contained in `tests/gen`), both as absolute time and number of clock cycles.
- [ ] What is the best timer source to use for measurement?
- [ ] How to get clock cycles from time?
- [ ] How to get stable measurement results?
- [ ] The difference in execution time between input scenarios 1 and 2 partly relates to branch prediction behavior. Using `perf state <interpreter>`, you can find out the number of branch mispredictions. How large is the cycle penalty of one misprediction for the CPU in your laptop on average?

## How to generate the scenarios

To generate the scenarios required to test the Virtual Machine, type the following commands:

```shell
cd tests/gen
make run
```